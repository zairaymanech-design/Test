import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.ldap.core.LdapTemplate;
import org.springframework.ldap.filter.EqualsFilter;
import org.springframework.stereotype.Service;

@Service
public class LdapGroupService {

    @Autowired
    private LdapTemplate ldapTemplate;

    public boolean isUserInGroup(String username, String groupDn) {
        String userDn = String.format("uid=%s,ou=Users,dc=example,dc=com", username);
        EqualsFilter memberFilter = new EqualsFilter("member", userDn);
        EqualsFilter groupFilter = new EqualsFilter("distinguishedName", groupDn);

        String searchFilter = String.format("(&(objectClass=groupOfNames)(cn=%s)(member=%s))",
                extractCnFromDn(groupDn), userDn);

        return ldapTemplate.search("", searchFilter, (attributes, name) -> name.toString())
                .stream()
                .findFirst()
                .isPresent();
    }

    private String extractCnFromDn(String dn) {
        // Example: "cn=Developers,ou=Groups,dc=example,dc=com" â†’ "Developers"
        String[] parts = dn.split(",");
        for (String part : parts) {
            if (part.trim().startsWith("cn=")) {
                return part.substring(3);
            }
        }
        return dn;
    }
}